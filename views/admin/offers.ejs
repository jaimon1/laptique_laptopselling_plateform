<%- include('../parsuals/admin/header') %>
    <link rel="stylesheet" href="/adminCss/offers.css">

    <div class="col-md-10 main-content">
        <div class="offers-container">


          
            <div class="page-header">
                <h1><i class="fas fa-percent me-3"></i>Offers Management</h1>
                <p>Manage product and category offers to boost sales</p>
            </div>

         
            <div class="offer-card">
                <div class="offer-card-header">
                    <div class="offer-icon product-offer-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="offer-card-title">
                        <h3>Product Offers</h3>
                        <p>Add discount offers to specific products</p>
                    </div>
                </div>

             
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="productSearch" class="form-control" placeholder="Search products...">
                </div>

           
                <div class="loading-spinner" id="productLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>


        
                <div class="table-container">
                    <table class="modern-table table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Regular Price</th>
                                <th>Current Offer</th>
                                <th>Sale Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                          
                        </tbody>
                    </table>
                </div>

             
                <div id="productPagination" class="pagination-container" style="display: none;">
                    <div class="pagination-info">
                        <span id="productPaginationInfo"></span>
                    </div>
                    <div class="pagination-buttons" id="productPaginationButtons">
                      
                    </div>
                </div>
            </div>

 
            <div class="offer-card">
                <div class="offer-card-header">
                    <div class="offer-icon category-offer-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="offer-card-title">
                        <h3>Category Offers</h3>
                        <p>Add discount offers to entire categories</p>
                    </div>
                </div>


            
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="categorySearch" class="form-control" placeholder="Search categories...">
                </div>

              
                <div class="loading-spinner" id="categoryLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

         
                <div class="table-container">
                    <table class="modern-table table">
                        <thead>
                            <tr>
                                <th>Category Name</th>
                                <th>Products Count</th>
                                <th>Current Offer</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
    
                        </tbody>
                    </table>
                </div>

                <div id="categoryPagination" class="pagination-container" style="display: none;">
                    <div class="pagination-info">
                        <span id="categoryPaginationInfo"></span>
                    </div>
                    <div class="pagination-buttons" id="categoryPaginationButtons">
                      
                    </div>
                </div>
            </div>
        </div>
    </div>


 
    <div class="modal fade" id="offerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 15px; border: none;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px 15px 0 0;">
                    <h5 class="modal-title" id="offerModalTitle">
                        <i class="fas fa-percent me-2"></i>Add Offer
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Offer Percentage</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="offerPercentage" min="1" max="90"
                                placeholder="Enter discount percentage">
                            <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Enter a value between 1 and 90</small>
                    </div>
                    <div id="offerPreview" class="alert alert-info" style="display: none;">
                        <strong>Preview:</strong> <span id="previewText"></span>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 2px solid #f0f0f0;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-add-offer" id="saveOfferBtn">
                        <i class="fas fa-check me-2"></i>Save Offer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentOfferId = null;
        let currentOfferType = null; 
        let currentProductPage = 1;
        let currentCategoryPage = 1;

      
        function showToast(message, type = 'success') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: type,
                title: message,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }


        async function loadProducts(search = '', page = 1) {
            document.getElementById('productLoading').style.display = 'block';
            document.getElementById('productsTableBody').innerHTML = '';
            currentProductPage = page;

            try {
                const response = await fetch(`/admin/offers/products?search=${search}&page=${page}&limit=10`);
                const data = await response.json();

                document.getElementById('productLoading').style.display = 'none';

                if (data.success && data.products.length > 0) {
                    renderProducts(data.products);
                    renderProductPagination(data.pagination, search);
                } else {
                    document.getElementById('productsTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>No products found</p>
                    </td>
                </tr>
            `;
                    document.getElementById('productPagination').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('productLoading').style.display = 'none';
                showToast('Failed to load products', 'error');
            }
        }


        function renderProducts(products) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = products.map(product => {
                const variant = product.variants && product.variants[0] ? product.variants[0] : { regularPrice: 0, salePrice: 0 };
                const hasOffer = product.productOffer > 0;
                const offerBadge = hasOffer
                    ? `<span class="offer-badge active">${product.productOffer}% OFF</span>`
                    : `<span class="offer-badge inactive">No Offer</span>`;

         
                const imagePath = product.ProductImages && product.ProductImages[0] ? product.ProductImages[0] : '';
                const imageUrl = imagePath ? `/uploads/re-images/${imagePath}` : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="50" height="50"%3E%3Crect fill="%23ddd" width="50" height="50"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" text-anchor="middle" dy=".3em" font-size="12"%3ENo Image%3C/text%3E%3C/svg%3E';

                return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${imageUrl}" class="product-image me-3" alt="${product.productName}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'50\\' height=\\'50\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'50\\' height=\\'50\\'/%3E%3Ctext fill=\\'%23999\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' font-size=\\'12\\'%3ENo Image%3C/text%3E%3C/svg%3E';">
                        <strong>${product.productName}</strong>
                    </div>
                </td>
                <td>${product.category?.name || 'N/A'}</td>
                <td>₹${variant.regularPrice}</td>
                <td>${offerBadge}</td>
                <td><strong class="text-success">₹${variant.salePrice}</strong></td>
                <td>
                    <button class="btn btn-sm btn-add-offer" onclick="openOfferModal('${product._id}', 'product', ${product.productOffer})">
                        <i class="fas fa-${hasOffer ? 'edit' : 'plus'}"></i> ${hasOffer ? 'Edit' : 'Add'}
                    </button>
                    ${hasOffer ? `
                        <button class="btn btn-sm btn-remove-offer ms-2" onclick="removeOffer('${product._id}', 'product')">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
            }).join('');
        }


        function renderProductPagination(pagination, search) {
            const paginationContainer = document.getElementById('productPagination');
            const paginationInfo = document.getElementById('productPaginationInfo');
            const paginationButtons = document.getElementById('productPaginationButtons');

            if (pagination.totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }

            paginationContainer.style.display = 'flex';
            paginationInfo.textContent = `Page ${pagination.currentPage} of ${pagination.totalPages} (${pagination.totalProducts} products)`;

            let buttonsHTML = '';


            if (pagination.hasPrevPage) {
                buttonsHTML += `<button class="pagination-btn" onclick="loadProducts('${search}', ${pagination.currentPage - 1})">
            <i class="fas fa-chevron-left"></i> Previous
        </button>`;
            }

  
            for (let i = 1; i <= pagination.totalPages; i++) {
                if (i === 1 || i === pagination.totalPages || (i >= pagination.currentPage - 2 && i <= pagination.currentPage + 2)) {
                    buttonsHTML += `<button class="pagination-btn ${i === pagination.currentPage ? 'active' : ''}" 
                onclick="loadProducts('${search}', ${i})">${i}</button>`;
                } else if (i === pagination.currentPage - 3 || i === pagination.currentPage + 3) {
                    buttonsHTML += `<span class="pagination-dots">...</span>`;
                }
            }

        
            if (pagination.hasNextPage) {
                buttonsHTML += `<button class="pagination-btn" onclick="loadProducts('${search}', ${pagination.currentPage + 1})">
            Next <i class="fas fa-chevron-right"></i>
        </button>`;
            }

            paginationButtons.innerHTML = buttonsHTML;
        }


   
        async function loadCategories(search = '', page = 1) {
            document.getElementById('categoryLoading').style.display = 'block';
            document.getElementById('categoriesTableBody').innerHTML = '';
            currentCategoryPage = page;

            try {
                const response = await fetch(`/admin/offers/categories?search=${search}&page=${page}&limit=10`);
                const data = await response.json();

                document.getElementById('categoryLoading').style.display = 'none';

                if (data.success && data.categories.length > 0) {
                    renderCategories(data.categories);
                    renderCategoryPagination(data.pagination, search);
                } else {
                    document.getElementById('categoriesTableBody').innerHTML = `
                <tr>
                    <td colspan="5" class="empty-state">
                        <i class="fas fa-layer-group"></i>
                        <p>No categories found</p>
                    </td>
                </tr>
            `;
                    document.getElementById('categoryPagination').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('categoryLoading').style.display = 'none';
                showToast('Failed to load categories', 'error');
            }
        }

 
        function renderCategories(categories) {
            const tbody = document.getElementById('categoriesTableBody');
            tbody.innerHTML = categories.map(category => {
                const hasOffer = category.categoryOffer > 0;
                const offerBadge = hasOffer
                    ? `<span class="offer-badge active">${category.categoryOffer}% OFF</span>`
                    : `<span class="offer-badge inactive">No Offer</span>`;
                const statusBadge = category.isListed
                    ? `<span class="badge bg-success">Active</span>`
                    : `<span class="badge bg-secondary">Inactive</span>`;

                return `
            <tr>
                <td><strong>${category.name}</strong></td>
                <td>${category.productCount || 0} products</td>
                <td>${offerBadge}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-add-offer" onclick="openOfferModal('${category._id}', 'category', ${category.categoryOffer})">
                        <i class="fas fa-${hasOffer ? 'edit' : 'plus'}"></i> ${hasOffer ? 'Edit' : 'Add'}
                    </button>
                    ${hasOffer ? `
                        <button class="btn btn-sm btn-remove-offer ms-2" onclick="removeOffer('${category._id}', 'category')">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
            }).join('');
        }


        function renderCategoryPagination(pagination, search) {
            const paginationContainer = document.getElementById('categoryPagination');
            const paginationInfo = document.getElementById('categoryPaginationInfo');
            const paginationButtons = document.getElementById('categoryPaginationButtons');

            if (pagination.totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }

            paginationContainer.style.display = 'flex';
            paginationInfo.textContent = `Page ${pagination.currentPage} of ${pagination.totalPages} (${pagination.totalCategories} categories)`;

            let buttonsHTML = '';

          
            if (pagination.hasPrevPage) {
                buttonsHTML += `<button class="pagination-btn" onclick="loadCategories('${search}', ${pagination.currentPage - 1})">
            <i class="fas fa-chevron-left"></i> Previous
        </button>`;
            }

     
            for (let i = 1; i <= pagination.totalPages; i++) {
                if (i === 1 || i === pagination.totalPages || (i >= pagination.currentPage - 2 && i <= pagination.currentPage + 2)) {
                    buttonsHTML += `<button class="pagination-btn ${i === pagination.currentPage ? 'active' : ''}" 
                onclick="loadCategories('${search}', ${i})">${i}</button>`;
                } else if (i === pagination.currentPage - 3 || i === pagination.currentPage + 3) {
                    buttonsHTML += `<span class="pagination-dots">...</span>`;
                }
            }

            
            if (pagination.hasNextPage) {
                buttonsHTML += `<button class="pagination-btn" onclick="loadCategories('${search}', ${pagination.currentPage + 1})">
            Next <i class="fas fa-chevron-right"></i>
        </button>`;
            }

            paginationButtons.innerHTML = buttonsHTML;
        }



        function openOfferModal(id, type, currentOffer = 0) {
            currentOfferId = id;
            currentOfferType = type;

            document.getElementById('offerModalTitle').innerHTML = `
        <i class="fas fa-percent me-2"></i>${currentOffer > 0 ? 'Edit' : 'Add'} ${type === 'product' ? 'Product' : 'Category'} Offer
    `;
            document.getElementById('offerPercentage').value = currentOffer > 0 ? currentOffer : '';
            document.getElementById('offerPreview').style.display = 'none';

            const modal = new bootstrap.Modal(document.getElementById('offerModal'));
            modal.show();
        }

        
        document.getElementById('offerPercentage').addEventListener('input', function () {
            const value = parseInt(this.value);
            const preview = document.getElementById('offerPreview');
            const previewText = document.getElementById('previewText');

            if (value >= 1 && value <= 90) {
                preview.style.display = 'block';
                previewText.textContent = `${value}% discount will be applied`;
            } else {
                preview.style.display = 'none';
            }
        });


     
        document.getElementById('saveOfferBtn').addEventListener('click', async function () {
            const percentage = parseInt(document.getElementById('offerPercentage').value);

            if (!percentage || percentage < 1 || percentage > 90) {
                showToast('Please enter a valid percentage between 1 and 90', 'error');
                return;
            }

            const endpoint = currentOfferType === 'product'
                ? '/admin/product/add-offer'
                : '/admin/addCatedoryOffer';

            const body = currentOfferType === 'product'
                ? { productId: currentOfferId, percentage }
                : { categoryId: currentOfferId, percentage };

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.success || data.status) {
                    showToast(`Offer ${percentage}% applied successfully!`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('offerModal')).hide();

                    
                    if (currentOfferType === 'product') {
                        loadProducts(document.getElementById('productSearch').value);
                    } else {
                        loadCategories(document.getElementById('categorySearch').value);
                    }
                } else {
                    showToast(data.message || 'Failed to apply offer', 'error');
                }
            } catch (error) {
                showToast('An error occurred', 'error');
            }
        });


        
        async function removeOffer(id, type) {
            const result = await Swal.fire({
                title: 'Remove Offer?',
                text: `Are you sure you want to remove this ${type} offer?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, remove it!'
            });

            if (result.isConfirmed) {
                const endpoint = type === 'product'
                    ? '/admin/product/remove-offer'
                    : '/admin/removeCategoryOffer';

                const body = type === 'product'
                    ? { productId: id }
                    : { categoryId: id };

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    const data = await response.json();

                    if (data.success || data.status) {
                        showToast('Offer removed successfully!', 'success');

                       
                        if (type === 'product') {
                            loadProducts(document.getElementById('productSearch').value);
                        } else {
                            loadCategories(document.getElementById('categorySearch').value);
                        }
                    } else {
                        showToast(data.message || 'Failed to remove offer', 'error');
                    }
                } catch (error) {
                    showToast('An error occurred', 'error');
                }
            }
        }


       
        let productSearchTimeout;
        document.getElementById('productSearch').addEventListener('input', function () {
            clearTimeout(productSearchTimeout);
            productSearchTimeout = setTimeout(() => {
                loadProducts(this.value, 1); 
            }, 500);
        });

        let categorySearchTimeout;
        document.getElementById('categorySearch').addEventListener('input', function () {
            clearTimeout(categorySearchTimeout);
            categorySearchTimeout = setTimeout(() => {
                loadCategories(this.value, 1); 
            }, 500);
        });

        
        document.addEventListener('DOMContentLoaded', function () {
            loadProducts('', 1);
            loadCategories('', 1);
        });
    </script>

    <%- include('../parsuals/admin/footer') %>