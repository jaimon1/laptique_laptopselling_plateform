<%-include("../../views/parsuals/admin/header")%>

<div class="col-md-10 p-0">
    <div class="topbar">
        <h4>Edit Coupon</h4>
    </div>
    
    <div class="p-4">
        <div class="card p-4">
            <h5 class="mb-4"><i class="fas fa-edit me-2"></i>Update Coupon Information</h5>
            
            <form id="editCouponForm">
                <input type="hidden" id="couponId" value="<%= coupon._id %>">
                
                <div class="row">
                
                    <div class="col-12 mb-4">
                        <div class="card bg-light p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Coupon Status</h6>
                                    <small class="text-muted">Enable or disable this coupon</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isActive" 
                                           style="width: 60px; height: 30px; cursor: pointer;"
                                           <%= coupon.isActive ? 'checked' : '' %>>
                                    <label class="form-check-label ms-2" for="isActive" id="statusLabel">
                                        <span class="badge bg-<%= coupon.isActive ? 'success' : 'danger' %>">
                                            <%= coupon.isActive ? 'Active' : 'Inactive' %>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <label class="form-label">Coupon Code *</label>
                        <input type="text" class="form-control" id="name" value="<%= coupon.name %>" readonly />
                        <small class="text-muted">Coupon code cannot be changed</small>
                    </div>

                    <div class="col-md-6 mb-4">
                        <label class="form-label">Expiry Date *</label>
                        <input type="date" class="form-control" id="expireOn" 
                               value="<%= new Date(coupon.expireOn).toISOString().split('T')[0] %>" required />
                        <small class="text-muted">Must be a future date</small>
                        <div class="invalid-feedback">Expiry date must be in the future</div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <label class="form-label">Discount Type *</label>
                        <select class="form-select" id="discountType" required>
                            <option value="">Select Type</option>
                            <option value="percentage" <%= coupon.discountType === 'percentage' ? 'selected' : '' %>>Percentage</option>
                            <option value="fixed" <%= coupon.discountType === 'fixed' ? 'selected' : '' %>>Fixed Amount</option>
                        </select>
                    </div>

                    <div class="col-md-6 mb-4">
                        <label class="form-label">Discount Value *</label>
                        <input type="number" class="form-control" id="discountValue" 
                               value="<%= coupon.discountValue %>" min="0.01" step="0.01" max="999999" required />
                        <small class="text-muted">For percentage: 1-100. For fixed: any positive amount</small>
                        <div class="invalid-feedback">Please enter a valid discount value</div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <label class="form-label">Minimum Purchase Amount *</label>
                        <input type="number" class="form-control" id="minimumPrice" 
                               value="<%= coupon.minimumPrice %>" min="0" step="0.01" max="999999" required />
                        <small class="text-muted">Minimum cart value to apply coupon (₹0 for no minimum)</small>
                        <div class="invalid-feedback">Please enter a valid minimum price</div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <label class="form-label">Usage Limit *</label>
                        <input type="number" class="form-control" id="usageLimit" 
                               value="<%= coupon.usageLimit %>" min="1" max="999999" required />
                        <small class="text-muted">Maximum number of users who can use this coupon</small>
                        <div class="invalid-feedback">Usage limit must be at least 1</div>
                    </div>

                    <div class="col-12 mb-4">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="4" maxlength="500"><%= coupon.description || '' %></textarea>
                        <small class="text-muted"><span id="descCharCount"><%= (coupon.description || '').length %></span>/500 characters</small>
                    </div>

                    <div class="col-12">
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Update Coupon
                            </button>
                            <a href="/admin/loadCoupon" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to List
                            </a>
                        </div>
                    </div>
                </div>
            </form>

            <div id="errorBox" class="mt-3"></div>
        </div>
    </div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

    const descriptionField = document.getElementById('description');
    const charCount = document.getElementById('descCharCount');
    
    descriptionField.addEventListener('input', function() {
        charCount.textContent = this.value.length;
    });


    const expireOnField = document.getElementById('expireOn');
    const currentExpiry = new Date('<%= coupon.expireOn %>');
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const minDate = currentExpiry < tomorrow ? currentExpiry : tomorrow;
    expireOnField.min = minDate.toISOString().split('T')[0];


    const discountTypeField = document.getElementById('discountType');
    const discountValueField = document.getElementById('discountValue');
    
    discountTypeField.addEventListener('change', function() {
        if (this.value === 'percentage') {
            discountValueField.max = 100;
            discountValueField.placeholder = '10 (1-100%)';
        } else if (this.value === 'fixed') {
            discountValueField.max = 999999;
            discountValueField.placeholder = '100 (Fixed amount in ₹)';
        }
    });


    document.getElementById('isActive').addEventListener('change', function() {
        const label = document.getElementById('statusLabel');
        if (this.checked) {
            label.innerHTML = '<span class="badge bg-success">Active</span>';
        } else {
            label.innerHTML = '<span class="badge bg-danger">Inactive</span>';
        }
    });

    document.getElementById("editCouponForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        
        const couponId = document.getElementById('couponId').value;
        
 
        const couponData = {
            expireOn: document.getElementById('expireOn').value,
            discountType: document.getElementById('discountType').value,
            discountValue: parseFloat(document.getElementById('discountValue').value),
            minimumPrice: parseFloat(document.getElementById('minimumPrice').value),
            usageLimit: parseInt(document.getElementById('usageLimit').value),
            description: document.getElementById('description').value.trim(),
            isActive: document.getElementById('isActive').checked
        };

 
        
     
        const expireDate = new Date(couponData.expireOn);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (!couponData.expireOn) {
            showError("Expiry date is required.");
            return;
        }

        if (expireDate <= today) {
            showError("Expiry date must be in the future.");
            return;
        }

  
        if (!couponData.discountType) {
            showError("Please select a discount type.");
            return;
        }

        if (!['percentage', 'fixed'].includes(couponData.discountType)) {
            showError("Invalid discount type selected.");
            return;
        }


        if (isNaN(couponData.discountValue) || couponData.discountValue <= 0) {
            showError("Discount value must be greater than zero.");
            return;
        }

        if (couponData.discountType === 'percentage' && couponData.discountValue > 100) {
            showError("Percentage discount cannot exceed 100%.");
            return;
        }

        if (couponData.discountValue > 999999) {
            showError("Discount value is too large.");
            return;
        }

      
        if (isNaN(couponData.minimumPrice) || couponData.minimumPrice < 0) {
            showError("Minimum price must be zero or greater.");
            return;
        }

        if (couponData.minimumPrice > 999999) {
            showError("Minimum price is too large.");
            return;
        }

      
        if (isNaN(couponData.usageLimit) || couponData.usageLimit < 1) {
            showError("Usage limit must be at least 1.");
            return;
        }

        if (couponData.usageLimit > 999999) {
            showError("Usage limit is too large.");
            return;
        }

 
        if (couponData.description.length > 500) {
            showError("Description must not exceed 500 characters.");
            return;
        }

      
        Swal.fire({
            title: 'Updating Coupon...',
            text: 'Please wait',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        try {
            
            const response = await fetch(`/admin/editCoupon/${couponId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(couponData)
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: result.message || 'Coupon updated successfully',
                    timer: 2000,
                    showConfirmButton: false
                });

                document.getElementById("errorBox").innerHTML = '';

                
                setTimeout(() => {
                    window.location.href = '/admin/loadCoupon';
                }, 2000);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: result.message || 'Failed to update coupon',
                    confirmButtonColor: '#ef4444'
                });
            }
        } catch (error) {
            console.error('Error updating coupon:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: 'An error occurred while updating the coupon. Please try again.',
                confirmButtonColor: '#ef4444'
            });
        }
    });

    function showError(msg) {
        const box = document.getElementById("errorBox");
        box.innerHTML = `<div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-2"></i>${msg}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
        window.scrollTo({ top: 0, behavior: "smooth" });
    }
</script>

<%-include("../../views/parsuals/admin/footer")%>
