<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - LapTique</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/orders.css">
</head>

<body class="orders-page"></body>
    <%-include("../../views/parsuals/user/header")%>
     <div style="margin-top: 70px;"></div>
    <!-- Orders Header -->
    <div class="orders-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0">
                        <i class="fas fa-shopping-bag me-3"></i>My Orders
                    </h1>
                    <p class="mb-0 opacity-75">
                        <% if (totalOrders> 0) { %>
                            <%= totalOrders %> order<%= totalOrders> 1 ? 's' : '' %> found
                                    <% } else { %>
                                        No orders found
                                        <% } %>
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <a href="/profile" class="btn btn-light">
                        <i class="fas fa-user me-2"></i>Back to Profile
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Search Section -->
        <div class="search-card">
            <form method="GET" action="/orders">
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label for="search" class="form-label">Search Orders</label>
                        <input type="text" class="form-control search-input" id="search" name="search"
                            value="<%= search %>" placeholder="Search by Order ID or Status">
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn search-btn flex-fill">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                            <% if (search) { %>
                                <a href="/orders" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i>
                                </a>
                                <% } %>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Orders List -->
        <% if (orders && orders.length> 0) { %>
            <% orders.forEach(order=> { %>
                <div class="order-card">
                    <!-- Order Header -->
                    <div class="order-header">
                        <div>
                            <span class="order-id">#<%= order.orderId %></span>
                            <small class="text-muted ms-3">
                                <i class="fas fa-calendar me-1"></i>
                                <%= new Date(order.createdOn).toLocaleDateString('en-IN', { year: 'numeric' ,
                                    month: 'short' , day: 'numeric' }) %>
                            </small>
                            <!-- Return Rejected Badge -->
                            <% if (order.returnStatus === 'Rejected') { %>
                                <span class="badge bg-danger ms-2" style="font-size: 0.75rem;">
                                    <i class="fas fa-times-circle me-1"></i>Return Rejected
                                </span>
                            <% } %>
                        </div>
                        <span class="status-badge status-<%= order.status.toLowerCase().replace(/\s+/g, '-') %>">
                            <i class="fas fa-<%= order.status === 'Pending' ? 'clock' : 
                                                order.status === 'Processing' ? 'cog' :
                                                order.status === 'Shipped' ? 'shipping-fast' :
                                                order.status === 'Out for Delivery' ? 'truck' :
                                                order.status === 'Delivered' ? 'check-circle' :
                                                order.status === 'Cancelled' ? 'times-circle' :
                                                order.status === 'Failed' ? 'exclamation-circle' :
                                                order.status === 'Return Request' ? 'undo' :
                                                'box' %> me-1"></i>
                            <%= order.status %>
                        </span>
                    </div>

                    <!-- Order Items -->
                    <div class="order-items">
                        <% order.orderItems.slice(0, 3).forEach(item=> { %>
                            <% if (item.product) { %>
                            <div class="order-item">
                                <% if (item.product.ProductImages && item.product.ProductImages.length > 0) { %>
                                    <img src="/uploads/re-images/<%= item.product.ProductImages[0] %>"
                                        alt="<%= item.product.productName %>" class="item-image"
                                        onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                                <% } else { %>
                                    <img src="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E"
                                        alt="No Image" class="item-image">
                                <% } %>
                                <div class="item-details">
                                    <h6>
                                        <%= item.product.productName || 'Product Unavailable' %>
                                    </h6>
                                    <small>
                                        <% if (item.variant && item.variant.storage) { %>
                                            <%= item.variant.storage %>
                                                <% } %>
                                                    <% if (item.status !=='Active' ) { %>
                                                        • <span
                                                            class="text-<%= item.status === 'Cancelled' ? 'danger' : 'warning' %>">
                                                            <%= item.status %>
                                                        </span>
                                                        <% } %>
                                    </small>
                                </div>
                                <div class="item-quantity">
                                    <%= item.quantity %>
                                </div>
                            </div>
                            <% } %>
                            <% }) %>
                                <% if (order.orderItems.length> 3) { %>
                                    <div class="text-center mt-2">
                                        <small class="text-muted">
                                            +<%= order.orderItems.length - 3 %> more item<%= order.orderItems.length -
                                                    3> 1 ? 's' : '' %>
                                        </small>
                                    </div>
                                    <% } %>
                    </div>

                    <!-- Order Footer -->
                    <div class="order-footer">
                        <div class="order-total">
                            Total: ₹<%= parseInt(order.finalAmount).toLocaleString() %>
                                <small class="text-muted">
                                    (<%= order.orderItems.reduce((total, item)=> total + item.quantity, 0) %> items)
                                </small>
                        </div>
                        <div class="order-actions">
                            <a href="/order/<%= order._id %>" class="btn btn-primary btn-sm-custom">
                                <i class="fas fa-eye me-1"></i>View Details
                            </a>
                            
                            <% if (order.paymentMethod !== 'COD' && (order.paymentStatus === 'Failed' || order.paymentStatus === 'Pending') && (order.status === 'Pending' || order.status === 'Failed')) { %>
                                <!-- Show Retry Payment for failed payments -->
                                <button class="btn btn-danger btn-sm-custom" onclick="retryPayment('<%= order._id %>')">
                                    <i class="fas fa-redo me-1"></i>Retry Payment
                                </button>
                            <% } else if (['Pending', 'Processing'].includes(order.status)) { %>
                                <!-- Show Cancel for normal pending/processing orders -->
                                <button class="btn btn-danger btn-sm-custom" onclick="cancelOrder('<%= order._id %>')">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            <% } %>
                            
                            <% if (order.status === 'Delivered') { %>
                                <button class="btn btn-warning btn-sm-custom" onclick="requestReturn('<%= order._id %>')">
                                    <i class="fas fa-undo me-1"></i>Return
                                </button>
                            <% } %>
                            
                            <% if (!(order.paymentMethod !== 'COD' && (order.paymentStatus === 'Failed' || order.paymentStatus === 'Pending'))) { %>
                                <!-- Only show invoice if payment is not failed/pending -->
                                <a href="/order/<%= order._id %>/invoice" class="btn btn-success btn-sm-custom" target="_blank">
                                    <i class="fas fa-download me-1"></i>Invoice
                                </a>
                            <% } %>
                        </div>
                    </div>
                </div>
                <% }) %>

                    <!-- Pagination -->
                    <% if (totalPages> 1) { %>
                        <div class="pagination-card">
                            <nav aria-label="Orders pagination">
                                <ul class="pagination justify-content-center mb-0">
                                    <% if (currentPage> 1) { %>
                                        <li class="page-item">
                                            <a class="page-link"
                                                href="/orders?page=<%= currentPage - 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %>">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                        </li>
                                        <% } %>

                                            <% for (let i=Math.max(1, currentPage - 2); i <=Math.min(totalPages,
                                                currentPage + 2); i++) { %>
                                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                                    <a class="page-link"
                                                        href="/orders?page=<%= i %><%= search ? '&search=' + encodeURIComponent(search) : '' %>">
                                                        <%= i %>
                                                    </a>
                                                </li>
                                                <% } %>

                                                    <% if (currentPage < totalPages) { %>
                                                        <li class="page-item">
                                                            <a class="page-link"
                                                                href="/orders?page=<%= currentPage + 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %>">
                                                                <i class="fas fa-chevron-right"></i>
                                                            </a>
                                                        </li>
                                                        <% } %>
                                </ul>
                            </nav>
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    Showing <%= (currentPage - 1) * 10 + 1 %> to <%= Math.min(currentPage * 10,
                                            totalOrders) %> of <%= totalOrders %> orders
                                </small>
                            </div>
                        </div>
                        <% } %>

                            <% } else { %>
                                <!-- Empty Orders -->
                                <div class="order-card">
                                    <div class="empty-orders">
                                        <i class="fas fa-shopping-bag"></i>
                                        <h3 class="mb-3">
                                            <% if (search) { %>
                                                No orders found for "<%= search %>"
                                                    <% } else { %>
                                                        No orders yet
                                                        <% } %>
                                        </h3>
                                        <p class="text-muted mb-4">
                                            <% if (search) { %>
                                                Try searching with different keywords or check your order ID.
                                                <% } else { %>
                                                    Start shopping to see your orders here!
                                                    <% } %>
                                        </p>
                                        <% if (search) { %>
                                            <a href="/orders" class="btn btn-primary">
                                                <i class="fas fa-list me-2"></i>View All Orders
                                            </a>
                                            <% } else { %>
                                                <a href="/shop" class="btn btn-primary">
                                                    <i class="fas fa-shopping-bag me-2"></i>Start Shopping
                                                </a>
                                                <% } %>
                                    </div>
                                </div>
                                <% } %>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Retry payment function
        async function retryPayment(orderId) {
            try {
                const confirmResult = await Swal.fire({
                    title: 'Retry Payment',
                    text: 'Do you want to retry the payment for this order?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, retry payment',
                    cancelButtonText: 'Cancel'
                });

                if (!confirmResult.isConfirmed) return;

                // Redirect to payment page or initiate payment
                window.location.href = `/order/${orderId}/retry-payment`;
            } catch (error) {
                console.error('Error retrying payment:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to retry payment'
                });
            }
        }

        // Cancel order function
        async function cancelOrder(orderId) {
            try {
                // Step 1: Ask for cancellation reason
                const { value: reason } = await Swal.fire({
                    title: 'Cancel Order',
                    html: `
                        <div style="text-align: left;">
                            <p style="margin-bottom: 1rem; color: #6c757d;">
                                Please provide a reason for cancellation (optional):
                            </p>
                            <textarea 
                                id="cancel-reason" 
                                class="swal2-textarea" 
                                placeholder="e.g., Changed my mind, Found a better deal, etc."
                                style="width: 100%; min-height: 100px; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 0.95rem; resize: vertical;"
                            ></textarea>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Continue',
                    cancelButtonText: 'Go Back',
                    confirmButtonColor: '#4f7cff',
                    cancelButtonColor: '#6c757d',
                    preConfirm: () => {
                        return document.getElementById('cancel-reason').value;
                    },
                    customClass: {
                        popup: 'animated-popup',
                        confirmButton: 'modern-btn',
                        cancelButton: 'modern-btn'
                    }
                });

                // If user cancelled, stop
                if (reason === undefined) return;

                // Step 2: Confirm cancellation
                const confirmResult = await Swal.fire({
                    title: 'Are you sure?',
                    html: `
                        <div style="text-align: left;">
                            <p style="color: #6c757d; margin-bottom: 0.5rem;">
                                You are about to cancel this order.
                            </p>
                            ${reason ? `<p style="color: #495057; margin-top: 1rem;"><strong>Reason:</strong> ${reason}</p>` : ''}
                            <p style="color: #dc3545; margin-top: 1rem; font-size: 0.9rem;">
                                <i class="fas fa-exclamation-triangle"></i> This action cannot be undone.
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Cancel Order',
                    cancelButtonText: 'No, Keep Order',
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    customClass: {
                        popup: 'animated-popup',
                        confirmButton: 'modern-btn',
                        cancelButton: 'modern-btn'
                    }
                });

                if (!confirmResult.isConfirmed) return;

                // Step 3: Show loading
                Swal.fire({
                    title: 'Cancelling Order...',
                    html: 'Please wait while we process your cancellation.',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Step 4: Send cancellation request
                const response = await fetch(`/order/${orderId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reason: reason || '' })
                });

                const data = await response.json();

                // Step 5: Show result
                if (data.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Order Cancelled!',
                        text: data.message || 'Your order has been cancelled successfully.',
                        confirmButtonColor: '#28a745',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Cancellation Failed',
                        text: data.message || 'Failed to cancel order. Please try again.',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while cancelling the order. Please try again.',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        // Request return function
        async function requestReturn(orderId) {
            try {
                // Step 1: Ask reason
                const { value: reason } = await Swal.fire({
                    title: 'Return Product',
                    input: 'text',
                    inputLabel: 'Please provide a reason for return (required):',
                    inputPlaceholder: 'Enter your reason...',
                    showCancelButton: true,
                    confirmButtonText: 'Submit',
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You must provide a reason!'
                        }
                    }
                });

                // If cancelled or no reason, stop
                if (!reason) return;

                // Step 2: Confirm return
                const confirmResult = await Swal.fire({
                    title: 'Are you sure?',
                    text: 'Do you really want to request a return for this order?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, request return',
                    cancelButtonText: 'Cancel'
                });

                if (!confirmResult.isConfirmed) return;

                // Step 3: Send request to server
                const response = await fetch(`/order/${orderId}/return`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reason: reason.trim() })
                });

                const data = await response.json();

                // Step 4: Show result
                if (data.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message
                    });
                }
            } catch (error) {
                console.error('Error requesting return:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to request return'
                });
            }
        }

        // Show alert function
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Auto-submit search form on Enter
        document.getElementById('search').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                this.form.submit();
            }
        });
    </script>

    <%-include("../../views/parsuals/user/footer")%>
</body>

</html>