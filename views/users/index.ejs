<%- include("../../views/parsuals/user/header") %>

 
    <section id="home" class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <div class="hero-content">
                        <div class="hero-badge">New Collection 2024</div>
                        <h1>Discover Premium Laptops</h1>
                        <p>Experience cutting-edge technology with our curated collection of high-performance laptops.
                            From gaming to productivity, find your perfect match.</p>
                        <div class="hero-buttons">
                            <a href="/shop" class="btn btn-hero">Explore Collection</a>
                            <a href="#shop" class="btn btn-hero-outline">View Products</a>
                        </div>
                        <div class="hero-stats">
                            <div class="stat-item">
                                <h3>500+</h3>
                                <p>Products</p>
                            </div>
                            <div class="stat-item">
                                <h3>50+</h3>
                                <p>Brands</p>
                            </div>
                            <div class="stat-item">
                                <h3>10k+</h3>
                                <p>Happy Customers</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="hero-image">
                        <div class="floating-card card-1">
                            <i class="fas fa-shipping-fast"></i>
                            <span>Free Shipping</span>
                        </div>
                        <div class="floating-card card-2">
                            <i class="fas fa-shield-alt"></i>
                            <span>Secure Payment</span>
                        </div>
                        <div class="floating-card card-3">
                            <i class="fas fa-headset"></i>
                            <span>24/7 Support</span>
                        </div>
                        <img src="https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=800&q=80" alt="Premium Laptop" class="main-laptop-img">
                    </div>
                </div>
            </div>
        </div>
    </section>


    <section id="shop" class="section-padding">
        <div class="container">
            <h2 class="section-title">Featured Products</h2>
            <p class="section-subtitle">Handpicked laptops designed to elevate your digital experience</p>
            <div class="row">
        
                <div class="col-12">
                    <div class="row">
              
                        <% for(let i=0; i < productData.length; i++) { %>
                            <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
                                <div class="product-card h-100 d-flex flex-column">

                           
                                    <div class="product-image position-relative">
                                        <img src="/Uploads/re-images/<%= productData[i].ProductImages[0] %>"
                                            alt="<%= productData[i].productName %>">
                                        <% 
                                        const productOffer = productData[i].productOffer || 0;
                                        const categoryOffer = productData[i].category?.categoryOffer || 0;
                                        const bestOffer = Math.max(productOffer, categoryOffer);
                                        %>
                                        <% if (bestOffer > 0) { %>
                                            <div class="offer-badge">
                                                <i class="fas fa-tag"></i><%= bestOffer %>% OFF
                                            </div>
                                        <% } else { %>
                                            <div class="product-badge">Popular</div>
                                        <% } %>
                                        
                                
                                        <button class="wishlist-btn"
                                            onclick="handleAddToWishlist(event, '<%= productData[i]._id %>')"
                                            title="Add to Wishlist">
                                            <i class="far fa-heart"></i>
                                        </button>
                                    </div>

                                  
                                    <div class="product-info d-flex flex-column flex-grow-1">
                                        <a href="javascript:void(0)"
                                            class="product-title text-truncate"
                                            onclick="handleProductClick('<%= productData[i]._id %>')">
                                            <%= productData[i].productName %>
                                        </a>

                                        <p class="text-muted small mb-2 text-truncate">
                                            <%= productData[i].shortDescription %>
                                        </p>

                                    
                                        <div class="price-container">
                                            <% 
                                            const variant = productData[i].variants[0];
                                            const hasOffer = variant.salePrice < variant.regularPrice;
                                            %>
                                            <% if (hasOffer) { %>
                                                <span class="regular-price">₹<%= variant.regularPrice %></span>
                                                <span class="sale-price">₹<%= variant.salePrice %></span>
                                                <span class="savings-badge">Save ₹<%= variant.regularPrice - variant.salePrice %></span>
                                            <% } else { %>
                                                <span class="sale-price">₹<%= variant.regularPrice %></span>
                                            <% } %>
                                        </div>

                                      
                                        <div class="mt-auto">
                                            <button class="btn btn-product"
                                                data-product-id="<%= productData[i]._id %>"
                                                data-variant-id="<%= productData[i].variants[0].storage %>"
                                                onclick="handleAddToCart(event, this)">
                                                <i class="fas fa-shopping-cart me-2"></i> Add to Cart
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <% } %>

                    </div>
                
                    <nav aria-label="Product pagination">
                        <ul class="pagination">

                            <% if(currentPage> 1) { %>
                                <li class="page-item">
                                    <a class="page-link" href="/?page=<%= currentPage - 1 %>" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <% } %>

                                    <% for(let i=1; i <=totalPages; i++) { %>
                                        <li class="page-item <%= currentPage === i ? 'active' : '' %>"><a
                                                class="page-link " href="/?page=<%= i %>">
                                                <%= i %>
                                            </a></li>
                                        <% } %>
                                            <% if(currentPage < totalPages) { %>
                                                <li class="page-item">
                                                    <a class="page-link  " href="/?page=<%= currentPage + 1 %>"
                                                        aria-label="Next">
                                                        <span aria-hidden="true">&raquo;</span>
                                                    </a>
                                                </li>
                                                <% } %>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </section>


    <section class="why-choose-section section-padding">
        <div class="container">
            <h2 class="section-title">Why Choose LAPTIQUE</h2>
            <p class="section-subtitle">We're committed to delivering excellence in every aspect</p>
            <div class="row">
                <div class="col-md-6 col-lg-3">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <h5 class="feature-title">Free Shipping</h5>
                        <p class="feature-description">Enjoy complimentary shipping on all orders. Fast delivery within
                            2-3 business days nationwide.</p>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h5 class="feature-title">Warranty Protection</h5>
                        <p class="feature-description">Extended warranty coverage and comprehensive protection plans for
                            complete peace of mind.</p>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-headset"></i>
                        </div>
                        <h5 class="feature-title">24/7 Support</h5>
                        <p class="feature-description">Expert technical support available around the clock to assist
                            with any questions or concerns.</p>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-undo-alt"></i>
                        </div>
                        <h5 class="feature-title">Easy Returns</h5>
                        <p class="feature-description">30-day hassle-free returns. Not satisfied? Get a full refund with
                            no questions asked.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <script>
       
        const isUserLoggedIn = <%= user ? 'true' : 'false' %>;

      
        function checkAuthentication() {
            if (!isUserLoggedIn) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

       
        function handleProductClick(productId) {
            if (checkAuthentication()) {
                window.location.href = `/product/${productId}`;
            }
        }

        
        async function handleAddToCart(event, buttonEl) {
            event.stopPropagation(); 
            if (!checkAuthentication()) return;

            const originalText = buttonEl.innerHTML;
            
            try {
                const productId = buttonEl?.dataset?.productId;
                const variantId = buttonEl?.dataset?.variantId;

                if (!productId || !variantId) {
                    showAlert('Variant information missing. Please open the product page to select an option.', 'warning');
                    return;
                }

               
                buttonEl.disabled = true;
                buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';

                const response = await fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productId,
                        variantId,
                        quantity: 1
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message || 'Product added to cart', 'success');

           
                    if (window.updateHeaderCartCount) {
                        window.updateHeaderCartCount(data.cartCount || 0);
                    }
                   
                    if (window.updateHeaderWishlistCount) {
                        try {
                            const resWL = await fetch('/wishlist/count');
                            const dWL = await resWL.json();
                            window.updateHeaderWishlistCount(dWL.wishlistCount || 0);
                        } catch (e) { }
                    }
                } else {
                    showAlert(data.message || 'Failed to add to cart', 'error');

                    if (data.redirect) {
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 1500);
                    }
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                showAlert('Failed to add item to cart. Please try again.', 'error');
            } finally {
    
                if (buttonEl) {
                    buttonEl.disabled = false;
                    buttonEl.innerHTML = originalText;
                }
            }
        }

        
        function showAlert(message, type) {
          
            const existingAlerts = document.querySelectorAll('.custom-alert');
            existingAlerts.forEach(alert => alert.remove());

         
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show custom-alert`;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

          
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 4000);
        }

        
        async function handleAddToWishlist(event, productId) {
            event.stopPropagation();
            if (!checkAuthentication()) return;

            const wishlistBtn = event.currentTarget;
            const heartIcon = wishlistBtn.querySelector('i');
            const isInWishlist = wishlistBtn.classList.contains('in-wishlist');

            try {
                
                const endpoint = isInWishlist ? '/wishlist/remove' : '/wishlist/add';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId })
                });
                const data = await response.json();

                if (data.success) {
                    if (isInWishlist) {
                       
                        showAlert(data.message || 'Removed from wishlist', 'success');
                        wishlistBtn.classList.remove('in-wishlist');
                        heartIcon.classList.remove('fas');
                        heartIcon.classList.add('far');
                        removeWishlistState(productId);
                    } else {
                        
                        showAlert(data.message || 'Added to wishlist', 'success');
                        wishlistBtn.classList.add('in-wishlist');
                        heartIcon.classList.remove('far');
                        heartIcon.classList.add('fas');
                        saveWishlistState(productId, true);
                    }
                    
                    if (window.updateHeaderWishlistCount) {
                        window.updateHeaderWishlistCount(data.wishlistCount || 0);
                    }
                } else {
                    showAlert(data.message || 'Failed to update wishlist', 'error');
                    if (data.redirect) {
                        setTimeout(() => { window.location.href = data.redirect; }, 1500);
                    }
                }
            } catch (err) {
                console.error('Wishlist error:', err);
                showAlert('Failed to update wishlist. Please try again.', 'error');
            }
        }

        
        function saveWishlistState(productId, isInWishlist) {
            let wishlistItems = JSON.parse(localStorage.getItem('wishlistItems') || '[]');
            if (isInWishlist && !wishlistItems.includes(productId)) {
                wishlistItems.push(productId);
            }
            localStorage.setItem('wishlistItems', JSON.stringify(wishlistItems));
        }

        
        function removeWishlistState(productId) {
            let wishlistItems = JSON.parse(localStorage.getItem('wishlistItems') || '[]');
            wishlistItems = wishlistItems.filter(id => id !== productId);
            localStorage.setItem('wishlistItems', JSON.stringify(wishlistItems));
        }

       
        function loadWishlistStates() {
            const wishlistItems = JSON.parse(localStorage.getItem('wishlistItems') || '[]');
            document.querySelectorAll('.wishlist-btn').forEach(btn => {
                const productCard = btn.closest('.product-card');
                if (productCard) {
                    const productLink = productCard.querySelector('.product-title');
                    if (productLink) {
                        const href = productLink.getAttribute('onclick');
                        const match = href && href.match(/'([^']+)'/);
                        if (match && wishlistItems.includes(match[1])) {
                            btn.classList.add('in-wishlist');
                            const heartIcon = btn.querySelector('i');
                            if (heartIcon) {
                                heartIcon.classList.remove('far');
                                heartIcon.classList.add('fas');
                            }
                        }
                    }
                }
            });
        }

        
        document.addEventListener('DOMContentLoaded', loadWishlistStates);

     
        document.addEventListener('DOMContentLoaded', function () {
            
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                if (!link.href.includes('/login') && !link.href.includes('/register')) {
                    link.addEventListener('click', function (e) {
                        if (!isUserLoggedIn && !link.href.includes('#')) {
                            e.preventDefault();
                            window.location.href = '/login';
                        }
                    });
                }
            });

            
            const shopButton = document.querySelector('.btn-hero');
            if (shopButton) {
                shopButton.addEventListener('click', function (e) {
                    if (!isUserLoggedIn) {
                        e.preventDefault();
                        window.location.href = '/login';
                    }
                });
            }

            
            const paginationLinks = document.querySelectorAll('.page-link');
            paginationLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    if (!isUserLoggedIn) {
                        e.preventDefault();
                        window.location.href = '/login';
                    }
                });
            });

          
            const footerLinks = document.querySelectorAll('.footer a');
            footerLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    if (!isUserLoggedIn && !link.href.includes('#')) {
                        e.preventDefault();
                        window.location.href = '/login';
                    }
                });
            });
        });
    </script>


    <%- include("../../views/parsuals/user/footer") %>